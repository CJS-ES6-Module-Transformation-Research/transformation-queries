!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){t.exports=require("net")},function(t,e){t.exports=require("events")},function(t,e,i){t.exports.Broker=i(3),t.exports.Member=i(5)},function(t,e,i){const s=i(0),n=i(1).EventEmitter,r=i(4);t.exports=class extends n{constructor(t,e,i){super(),this.port=t||1337,this.host=e||"127.0.0.1",this.server=s.createServer(),this.topics={},this.wildcards={},this.openTasks={},this.eof="\n",this.block=void 0===i||i}getConnections(t){t="function"==typeof t?t:function(){},this.server.getConnections((function(e,i){t(e,i)}))}connection(){let t=this;this.server.on("connection",(function(e){e.setEncoding("utf8"),t.events(e),t.messages(e)}))}listen(){let t=this;this.connection(),this.server.listen({host:this.host,port:this.port},(function(){console.log("tcppubsub-broker listening on %j",t.server.address())}))}messages(t){let e=this,i="",s=[],n=0,r="";t.on("data",(function(o){if(i+=o.toString(),-1!==i.indexOf(e.eof)){s=i.split(e.eof),i="",n=s.length;for(let o=0;o<n;o++)try{r=s.shift(),e.handle(r.charAt(0),JSON.parse(r.substr(1,r.length)),t)}catch(t){t&&(i=r)}}}))}handle(t,e,i){switch(t){case"p":this.publish(e,i),Object.keys(this.wildcards).length&&this.wildcardpublish(e,i),this.emit("published",e);break;case"s":for(let t in e)this.subscribe(e[t],i),this.emit("subscribed",e[t]);break;case"u":for(let t in e)this.unsubscribe(e[t],i),this.emit("unsubscribed",e[t]);break;case"d":this.destroy(i),this.emit("destroy",i.address());break;default:this.emit("default",e)}}events(t){let e=this,i=t.remoteAddress+":"+t.remotePort;this.emit("clientConnected","Client connected: "+i),t.on("end",(function(){e.emit("end","end")})),t.on("close",(function(){e.emit("close","Socket close")})),t.on("error",(function(i){e.emit("error",i.message),e.destroy(t)}))}publish(t,e){if(this.topics[t.t])for(let i in this.topics[t.t])try{this.block?this.topics[t.t][i]!==e&&this.topics[t.t][i].write(Buffer.from(JSON.stringify(t)+this.eof)):this.topics[t.t][i].write(Buffer.from(JSON.stringify(t)+this.eof))}catch(e){delete this.topics[t.t][i]}else this.openTasks[t.t]=t}wildcardpublish(t,e){for(let i in this.wildcards)if(r(t.t,i))for(let s in this.wildcards[i])try{this.block?this.wildcards[i][s]!==e&&this.wildcards[i][s].write(Buffer.from(JSON.stringify(t)+this.eof)):this.wildcards[i][s].write(Buffer.from(JSON.stringify(t)+this.eof))}catch(e){delete this.topics[t.t][s]}}subscribe(t,e){-1===t.indexOf("#")?(this.topics[t]||(this.topics[t]=[]),this.topics[t].push(e),this.openTasks[t]&&(this.publish(this.openTasks[t]),delete this.openTasks[t])):this.wildcardsubscribe(t,e)}wildcardsubscribe(t,e){let i=t.replace(/#/g,"*");this.wildcards[i]||(this.wildcards[i]=[]),this.wildcards[i].push(e);for(let e in this.openTasks)r(t,e)&&(this.wildcardpublish(this.openTasks[e]),delete this.openTasks[e])}unsubscribe(t,e){-1===t.indexOf("#")?this.topics[t]&&this.deleteTopic(t,e):this.wildcardunsubscribe(t,e)}wildcardunsubscribe(t,e){let i=t.replace(/#/g,"*");this.wildcards[i]&&this.deleteWildcard(i,e)}destroy(t){for(let e in this.topics)this.deleteTopic(e,t);this.wildcarddestroy(t)}wildcarddestroy(t){for(let e in this.wildcards)this.deleteWildcard(e,t)}deleteTopic(t,e){let i=this.topics[t].indexOf(e);i>=0&&this.topics[t].splice(i,1),this.topics[t].length||delete this.topics[t]}deleteWildcard(t,e){let i=this.wildcards[t].indexOf(e);i>=0&&this.wildcards[t].splice(i,1),this.wildcards[t].length||delete this.wildcards[t]}pub(t,e){this.publish({t:t,p:e})}}},function(t,e){t.exports=require("node-wildcard")},function(t,e,i){let s=i(0),n=i(1).EventEmitter;t.exports=class extends n{constructor(t,e){super(),this.port=t||1337,this.host=e||"127.0.0.1",this.client=new s.Socket,this.eof="\n",this.messages(),this.connected=!1,this.reconnectTime=5e3,this.isReconnecting=!1,this.isKeepalive=!0,this.keepaliveDelay=36e5,this.topics={},this.requestCallbacks={},this.listenCallbacks={},this.responseCallback={},this.timeouts={}}get isConnected(){return this.connected}set keepalive(t){this.isKeepalive=t}createId(){return"req:"+Math.random().toString(36).substr(2,9)+"/"+Math.random().toString(36).substr(2,9)}connect(t){let e=this;t="function"==typeof t?t:function(){},this.client.connect(this.port,this.host,(function(){e.connected=!0,e.client.setEncoding("utf8"),e.client.setKeepAlive(e.isKeepalive,e.keepaliveDelay);let i=Object.keys(e.topics);i.length&&e.isReconnecting&&(e.isReconnecting=!1,e.sub(i)),t()}))}sub(t,e){let i=this;e="function"==typeof e?e:function(){},Array.isArray(t)||(t=[t]);for(let e in t)this.topics[t[e]]=!0;this.connected&&(this.client.write(Buffer.from("s"+JSON.stringify(t)+i.eof)),e(t))}unsub(t,e){let i=this;e="function"==typeof e?e:function(){},Array.isArray(t)||(t=[t]),this.connected&&(this.client.write(Buffer.from("u"+JSON.stringify(t)+i.eof)),e(t))}pub(t,e,i){i="function"==typeof i?i:function(){},this.connected&&(this.client.write(Buffer.from("p"+JSON.stringify({t:t,p:e})+this.eof)),i(t,e))}req(t,e,i,s){let n=this,r=this.createId();i="function"==typeof i?i:function(){},this.connected&&(this.requestCallbacks[r]=i,this.client.write(Buffer.from("s"+JSON.stringify({t:[r]})+this.eof)),this.client.write(Buffer.from("p"+JSON.stringify({t:t,p:e,r:r})+this.eof)),this.timeouts[r]=setTimeout((function(){n.requestCallbacks[r]("timeout"),delete n.requestCallbacks[r],n.client.write(Buffer.from("u"+JSON.stringify({t:[r]})+n.eof))}),s||6e5))}res(t){this.connected&&(void 0===t&&(t=""),this.client.write(Buffer.from("p"+JSON.stringify({t:this._lastRequestId,p:t})+this.eof)))}listen(t,e){this.connected&&(this.listenCallbacks[t]=e,this.sub(t))}messages(){let t=this,e="",i=[],s=0,n="";this.client.on("data",(function(r){if(e+=r.toString(),-1!==e.indexOf(t.eof)){i=e.split(t.eof),s=i.length,e="";for(let r=0;r<s;r++)try{if(n=i.shift(),n=JSON.parse(n),t.requestCallbacks[n.t])t.requestCallbacks[n.t](null,n.p,n.t),t.client.write(Buffer.from("u"+JSON.stringify([n.t])+t.eof)),clearTimeout(t.timeouts[n.t]),delete t.timeouts[n.t],delete t.requestCallbacks[n.t];else if(t.listenCallbacks[n.t]){t._lastRequestId=n.r;let e=t.res.bind(t);t.listenCallbacks[n.t](n.p,e)}else t.emit("message",n.t,n.p),t.listeners(n.t).length&&t.emit(n.t,n.p)}catch(t){t&&(e=n.toString())}}})),this.client.on("close",(function(){t.connected=!1,t.isConnected&&!t.client.destroyed()&&(delete t.topics,t.client.destroy()),t.emit("close","closed")})),this.client.on("error",(function(e){t.isReconnecting=!0,("ECONNREFUSED"===e.code||"ECONNRESET"===e.code)&&setTimeout(()=>t.connect(),t.reconnectTime)}))}destroy(){this.client.write(Buffer.from("d")+this.eof)}}}]);